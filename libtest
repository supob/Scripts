--// Script completamente eseguibile, da copiare e incollare in un executor
--// Questo script crea tutto da zero e avvia il menu GTA style

local function create(className, props)
    local inst = Instance.new(className)
    for k, v in pairs(props or {}) do
        inst[k] = v
    end
    return inst
end

local function tween(inst, tweenInfo, props)
    local TweenService = game:GetService("TweenService")
    local t = TweenService:Create(inst, tweenInfo, props)
    t:Play()
    return t
end

local function clamp(n, a, b)
    if n < a then return a end
    if n > b then return b end
    return n
end

local function roundToStep(value, step)
    if step <= 0 then return value end
    return math.floor((value / step) + 0.5) * step
end

--// Tema (stile GTA/FiveM)
local Theme = {
    PanelBg = Color3.fromRGB(12,12,12),
    PanelBgTransparency = 0.22,
    Text = Color3.fromRGB(235,235,235),
    MutedText = Color3.fromRGB(170,170,170),
    Stroke = Color3.fromRGB(60,60,60),
    StrokeTransparency = 0.25,
    Glow = Color3.fromRGB(255,255,255),
    GlowTransparency = 0.92,
    HighlightBg = Color3.fromRGB(255,255,255),
    HighlightTransparency = 0.92,
    HighlightBar = Color3.fromRGB(235,235,235),
    Accent = Color3.fromRGB(220,220,220),
    SliderTrack = Color3.fromRGB(35,35,35),
    SliderFill = Color3.fromRGB(235,235,235),
    DropdownBg = Color3.fromRGB(10,10,10),
    DropdownBgTransparency = 0.18,
}

local TweenFast = TweenInfo.new(0.12, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local TweenMed  = TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local TweenSlow = TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)

--// Creazione di tutto il menu
local function createMenu()
    local plr = game.Players.LocalPlayer
    local camGui = create("ScreenGui",{
        Name = "GTA_Menu",
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
    })
    camGui.Parent = game:GetService("CoreGui") -- puoi anche usare PlayerGui, ma potrebbe richiedere più permessi

    local root = create("Frame",{
        Name = "Root",
        Size = UDim2.new(0,420,0,420),
        Position = UDim2.new(0,40,0,120),
        BackgroundColor3 = Theme.PanelBg,
        BackgroundTransparency = Theme.PanelBgTransparency,
        BorderSizePixel = 0,
        Parent = camGui,
    })
    create("UICorner", {CornerRadius = UDim.new(0,10), Parent = root})
    create("UIStroke", {Color = Theme.Stroke, Thickness=1, Transparency=Theme.StrokeTransparency, ApplyStrokeMode=Enum.ApplyStrokeMode.Border, Parent = root})

    -- Glow
    local glow = create("Frame",{
        Size=UDim2.new(1,12,1,12),
        Position=UDim2.new(0,-6,0,-6),
        BackgroundTransparency=1,
        ZIndex = root.ZIndex - 1,
        Parent=root,
    })
    create("UICorner", {CornerRadius=UDim.new(0,12), Parent=glow})
    create("UIStroke", {Color=Theme.Glow, Thickness=2, Transparency=Theme.GlowTransparency, ApplyStrokeMode=Enum.ApplyStrokeMode.Border, Parent=glow})

    -- Header
    local header = create("Frame",{
        Size=UDim2.new(1,-18,0,64),
        Position=UDim2.fromOffset(9,8),
        BackgroundTransparency=1,
        Parent=root,
    })
    create("UIStroke", {Color=Theme.Stroke, Thickness=1, Transparency=Theme.StrokeTransparency, ApplyStrokeMode=Enum.ApplyStrokeMode.Border, Parent=header})

    local titleLbl = create("TextLabel",{
        Text="My GTA Menu",
        TextColor3=Theme.Text,
        TextSize=20,
        Font=Enum.Font.GothamBold,
        TextXAlignment=Enum.TextXAlignment.Left,
        Size=UDim2.new(1,0,0,28),
        BackgroundTransparency=1,
        Parent=header,
    })
    local subtitleLbl = create("TextLabel",{
        Text="Roblox",
        TextColor3=Theme.MutedText,
        TextSize=13,
        Font=Enum.Font.Gotham,
        TextXAlignment=Enum.TextXAlignment.Left,
        Size=UDim2.new(1,0,0,18),
        Position=UDim2.fromOffset(0,30),
        BackgroundTransparency=1,
        Parent=header,
    })
    local divider = create("Frame",{
        Size=UDim2.new(1,0,0,1),
        Position=UDim2.new(0,0,1,-2),
        BackgroundColor3=Theme.Stroke,
        BackgroundTransparency=0.55,
        BorderSizePixel=0,
        Parent=header,
    })

    -- Content
    local content = create("Frame",{
        Size=UDim2.new(1,-18,1,-86),
        Position=UDim2.fromOffset(9,80),
        BackgroundTransparency=1,
        Parent=root,
    })
    local list = create("ScrollingFrame",{
        Name="List",
        Size=UDim2.new(1,0,1,0),
        BackgroundTransparency=1,
        CanvasSize=UDim2.fromOffset(0,0),
        ScrollBarThickness=3,
        ScrollBarImageTransparency=0.35,
        ScrollingDirection=Enum.ScrollingDirection.Y,
        Parent=content,
    })
    local pad = create("UIPadding",{
        PaddingTop=UDim.new(0,6),
        PaddingBottom=UDim.new(0,6),
        PaddingLeft=UDim.new(0,6),
        PaddingRight=UDim.new(0,6),
    })
    pad.Parent=list
    local layout = create("UIListLayout",{
        Padding=UDim.new(0,6),
        FillDirection=Enum.FillDirection.Vertical,
        HorizontalAlignment=Enum.HorizontalAlignment.Center,
        SortOrder=Enum.SortOrder.LayoutOrder,
    })
    layout.Parent=list

    local hint = create("TextLabel",{
        Text="Numpad: 8/2 su-giù • 4/6 cambia • Enter seleziona • Backspace indietro • F8 toggle",
        TextColor3=Theme.MutedText,
        TextSize=11,
        Font=Enum.Font.Gotham,
        BackgroundTransparency=1,
        Size=UDim2.new(1,-18,0,18),
        Position=UDim2.fromOffset(9,game:GetService("RunService"):GetRobloxGui():GetGuiInset().Y + 420),
        Parent=root,
    })

    -- Variabili di stato
    local currentSection = nil
    local selectionIndex = 1
    local mode = "SECTIONS" -- SECTIONS / ELEMENTS / DROPDOWN
    local history = {}
    local dropdownState = nil
    local destroyed = false

    -- Funzione per creare elementi
    local function createRow(index, isHeader)
        local row = create("Frame",{
            Size=UDim2.new(1,0,0, isHeader and 30 or 44),
            BackgroundTransparency=1,
            LayoutOrder=index,
        })
        local btn = create("TextButton",{
            Size=UDim2.new(1,0,1,0),
            BackgroundTransparency=1,
            Text="",
            AutoButtonColor=false,
        })
        btn.Parent = row
        local hl = create("Frame",{
            Size=UDim2.new(1,0,1,0),
            BackgroundColor3=Theme.HighlightBg,
            BackgroundTransparency=1,
            BorderSizePixel=0,
            ZIndex=2,
        })
        hl.Parent=row
        create("UICorner",{CornerRadius=UDim.new(0,8), Parent=hl})
        local bar = create("Frame",{
            Size=UDim2.new(0,3,1,-12),
            Position=UDim2.fromOffset(8,6),
            BackgroundColor3=Theme.HighlightBar,
            BackgroundTransparency=1,
            BorderSizePixel=0,
            ZIndex=3,
        })
        bar.Parent=row
        create("UICorner",{CornerRadius=UDim.new(0,6), Parent=bar})
        local titleLbl = create("TextLabel",{
            Text="",
            Size=UDim2.new(1,-120,1,0),
            Position=UDim2.fromOffset(16,0),
            Font=Enum.Font.Gotham,
            TextSize=14,
            TextXAlignment=Enum.TextXAlignment.Left,
            TextColor3=Theme.Text,
            BackgroundTransparency=1,
        })
        titleLbl.Parent=row
        local rightLbl = create("TextLabel",{
            Text="",
            Size=UDim2.new(0,90,1,0),
            Position=UDim2.new(1,-10,0,0),
            AnchorPoint=Vector2.new(1,0),
            Font=Enum.Font.GothamSemibold,
            TextSize=13,
            TextXAlignment=Enum.TextXAlignment.Right,
            TextColor3=Theme.MutedText,
            BackgroundTransparency=1,
        })
        rightLbl.Parent=row

        local stroke = create("UIStroke",{
            Color=Theme.Accent,
            Thickness=1,
            Transparency=1,
            ApplyStrokeMode=Enum.ApplyStrokeMode.Border,
        })
        stroke.Parent=hl

        return {
            Frame=row,
            Button=btn,
            Highlight=hl,
            Bar=bar,
            Title=titleLbl,
            Right=rightLbl,
            _Stroke=stroke,
        }
    end

    -- Funzioni di navigazione
    local function applyHighlight()
        local children = list:GetChildren()
        local rows = {}
        for _, c in ipairs(children) do
            if c:IsA("Frame") and c:FindFirstChild("Highlight") then
                table.insert(rows, c)
            end
        end
        local maxIndex=#rows
        if maxIndex==0 then return end
        if selectionIndex<1 then selectionIndex=1 end
        if selectionIndex>#rows then selectionIndex=#rows end

        for i, row in ipairs(rows) do
            local isSel = (i==selectionIndex)
            if mode=="DROPDOWN" and i==1 then
                isSel=false
            end
            local targetHl= isSel and Theme.HighlightTransparency or 1
            local targetBar= isSel and 0.15 or 1
            local targetStroke= isSel and 0.65 or 1
            tween(row, TweenFast, {BackgroundTransparency=targetHl})
            tween(row.Bar, TweenFast, {BackgroundTransparency=targetBar})
            if row._Stroke then
                tween(row._Stroke, TweenFast, {Transparency=targetStroke})
            end
        end
    end

    local function clearList()
        for _, c in ipairs(list:GetChildren()) do
            if c:IsA("Frame") or c:IsA("TextButton") or c:IsA("TextLabel") then
                c:Destroy()
            end
        end
    end

    local function pushHistory()
        table.insert(history, {
            mode=mode,
            section=currentSection,
            selection=selectionIndex,
            dropdown=dropdownState,
        })
    end

    local function popHistory()
        local last=table.remove(history)
        if not last then return end
        mode=last.mode
        currentSection=last.section
        selectionIndex=last.selection
        dropdownState=last.dropdown
    end

    local function renderSections()
        clearList()
        mode="SECTIONS"
        currentSection=nil
        dropdownState=nil
        for i, sec in ipairs(sections) do
            local row=createRow(i)
            row.Frame.Name="Section_"..sec.Name
            row.Frame.Parent = list
            row.Title.Text=sec.Name
            row.Right.Text="→"
            row.Button.MouseButton1Click:Connect(function()
                selectionIndex=i
                applyHighlight()
                enterSection(i)
            end)
        end
        if #sections==0 then return end
        if selectionIndex<1 then selectionIndex=1 end
        if selectionIndex>#sections then selectionIndex=#sections end
        applyHighlight()
    end

    local function renderElements(section)
        clearList()
        mode="ELEMENTS"
        currentSection=section
        dropdownState=nil
        local visibleElements=section:_getVisibleElements()
        for i,el in ipairs(visibleElements) do
            local row=createRow(i)
            row.Frame.Name="Element_"..el.Id
            row.Frame.Parent = list
            row.Title.Text=el.Text
            if el.Type=="Label" then
                row.Right.Text=""
                row.Button.AutoButtonColor=false
                row.Button.Active=false
                row.Button.Selectable=false
                row.Title.TextColor3=Theme.MutedText
            elseif el.Type=="Button" then
                row.Right.Text="→"
                row.Button.MouseButton1Click:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    el:Activate()
                end)
            elseif el.Type=="Toggle" then
                row.Right.Text=el.Value and "ON" or "OFF"
                row.Right.TextColor3=el.Value and Theme.Text or Theme.MutedText
                row.Button.MouseButton1Click:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    el:Set(not el.Value)
                    row.Right.Text=el.Value and "ON" or "OFF"
                    row.Right.TextColor3=el.Value and Theme.Text or Theme.MutedText
                end)
            elseif el.Type=="Slider" then
                row.Right.Text=tostring(el.Value)
                local barWrap=create("Frame",{
                    Size=UDim2.new(1,-180,0,10),
                    Position=UDim2.new(0,14,1,-14),
                    BackgroundTransparency=1,
                })
                barWrap.Parent=row.Frame
                local track=create("Frame",{
                    Size=UDim2.new(1,0,1,0),
                    BackgroundColor3=Theme.SliderTrack,
                    BackgroundTransparency=0.2,
                    BorderSizePixel=0,
                })
                track.Parent=barWrap
                create("UICorner",{CornerRadius=UDim.new(0,8),Parent=track})
                local fill=create("Frame",{
                    Size=UDim2.new(0,0,1,0),
                    BackgroundColor3=Theme.SliderFill,
                    BackgroundTransparency=0.05,
                    BorderSizePixel=0,
                })
                fill.Parent=track
                create("UICorner",{CornerRadius=UDim.new(0,8),Parent=fill})

                local function updateFill()
                    local pct=0
                    if el.Max>el.Min then
                        pct=(el.Value - el.Min)/(el.Max-el.Min)
                    end
                    pct=clamp(pct,0,1)
                    fill.Size=UDim2.new(pct,0,1,0)
                    row.Right.Text=tostring(el.Value)
                end
                updateFill()

                local dragging=false
                local function setFromMouse()
                    local mouseX=game:GetService("UserInputService"):GetMouseLocation().X
                    local absPos=track.AbsolutePosition
                    local absSize=track.AbsoluteSize
                    local x=clamp(mouseX - absPos.X,0,absSize.X)
                    local pct = (absSize.X>0) and (x/absSize.X) or 0
                    local raw=el.Min+(el.Max - el.Min)*pct
                    local v=roundToStep(raw,el.Step)
                    el:Set(v)
                    updateFill()
                end

                row.Button.MouseButton1Down:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    dragging=true
                    setFromMouse()
                end)

                game:GetService("UserInputService").InputEnded:Connect(function(input)
                    if input.UserInputType==Enum.UserInputType.MouseButton1 then
                        dragging=false
                    end
                end)

                game:GetService("UserInputService").InputChanged:Connect(function(input,gpe)
                    if gpe then return end
                    if dragging and input.UserInputType==Enum.UserInputType.MouseMovement then
                        setFromMouse()
                    end
                end)

                el._uiUpdate=updateFill
            elseif el.Type=="Dropdown" then
                row.Right.Text=el.Options[el.ValueIndex] or ""
                row.Button.MouseButton1Click:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    renderDropdown(el,i)
                end)
            end
        end
        if selectionIndex<1 then selectionIndex=1 end
        if selectionIndex>#visibleElements then selectionIndex=#visibleElements end
        applyHighlight()
    end

    local function renderDropdown(element,parentIdx)
        clearList()
        mode="DROPDOWN"
        dropdownState={
            element=element,
            parentIndex=parentIdx,
            selectionIndex=element.ValueIndex or 1,
        }
        -- Header
        local headerRow=createRow(1,true)
        headerRow.Title.Text=element.Text.." (Select)"
        headerRow.Right.Text=""
        headerRow.Button.Active=false
        headerRow.Button.Selectable=false
        headerRow.Title.TextColor3=Theme.MutedText
        headerRow.Frame.Parent=list

        -- Opzioni
        for i,opt in ipairs(element.Options) do
            local row=createRow(i+1)
            row.Frame.Parent=list
            row.Title.Text=tostring(opt)
            row.Right.Text=(i==(element.ValueIndex or 1)) and "✓" or ""
            row.Button.MouseButton1Click:Connect(function()
                dropdownState.selectionIndex=i
                applyHighlight()
                element:SetIndex(i)
                closeDropdown()
            end)
        end
        selectionIndex=math.clamp((dropdownState.selectionIndex or 1)+1,2,#element.Options+1)
        applyHighlight()
    end

    local function openDropdown(e,pIdx)
        pushHistory()
        tween(root, TweenSlow, {BackgroundTransparency=Theme.PanelBgTransparency})
        renderDropdown(e,pIdx)
    end

    local function closeDropdown()
        local dd=dropdownState
        if not dd then
            enterSection(selectionIndex)
            return
        end
        local el=dd.element
        local pIdx=dd.parentIndex
        tween(root, TweenSlow, {BackgroundTransparency=Theme.PanelBgTransparency})
        enterSection(currentSection)
        selectionIndex=pIdx
        applyHighlight()
        popHistory()
    end

    -- Input handler
    local inputConn
    inputConn = game:GetService("UserInputService").InputBegan:Connect(function(input,gpe)
        if gpe or destroyed then return end
        if input.KeyCode==Enum.KeyCode.F8 then
            if root.Visible then root.Visible=false else root.Visible=true end
        end
        if not root.Visible then return end
        if input.KeyCode==Enum.KeyCode.KeypadEight then
            if mode=="DROPDOWN" then
                selectionIndex=math.clamp(selectionIndex-1,2,#(dropdownState.element.Options)+1)
            else
                selectionIndex=selectionIndex-1
                if mode=="SECTIONS" then
                    selectionIndex=math.clamp(selectionIndex,1,#sections)
                else
                    selectionIndex=math.clamp(selectionIndex,1,#(currentSection:_getVisibleElements()))
                end
            end
            applyHighlight()
        elseif input.KeyCode==Enum.KeyCode.KeypadTwo then
            if mode=="DROPDOWN" then
                selectionIndex=math.clamp(selectionIndex+1,2,#(dropdownState.element.Options)+1)
            else
                selectionIndex=selectionIndex+1
                if mode=="SECTIONS" then
                    selectionIndex=math.clamp(selectionIndex,1,#sections)
                else
                    selectionIndex=math.clamp(selectionIndex,1,#(currentSection:_getVisibleElements()))
                end
            end
            applyHighlight()
        elseif input.KeyCode==Enum.KeyCode.KeypadFour then
            if mode=="ELEMENTS" then
                local els=currentSection:_getVisibleElements()
                local el=els[selectionIndex]
                if not el then return end
                if el.Type=="Slider" then
                    el:Set(el.Value - el.Step)
                    if el._uiUpdate then el._uiUpdate() end
                elseif el.Type=="Toggle" then
                    el:Set(false)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                elseif el.Type=="Dropdown" then
                    el:SetIndex((el.ValueIndex or 1)-1)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                end
            elseif mode=="DROPDOWN" then
                -- optional
                selectionIndex=math.clamp(selectionIndex-1,2,#(dropdownState.element.Options)+1)
                applyHighlight()
            end
        elseif input.KeyCode==Enum.KeyCode.KeypadSix then
            if mode=="ELEMENTS" then
                local els=currentSection:_getVisibleElements()
                local el=els[selectionIndex]
                if not el then return end
                if el.Type=="Slider" then
                    el:Set(el.Value + el.Step)
                    if el._uiUpdate then el._uiUpdate() end
                elseif el.Type=="Toggle" then
                    el:Set(true)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                elseif el.Type=="Dropdown" then
                    el:SetIndex((el.ValueIndex or 1)+1)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                end
            elseif mode=="DROPDOWN" then
                -- optional
                selectionIndex=math.clamp(selectionIndex+1,2,#(dropdownState.element.Options)+1)
                applyHighlight()
            end
        elseif input.KeyCode==Enum.KeyCode.Return or input.KeyCode==Enum.KeyCode.KeypadEnter then
            if mode=="SECTIONS" then
                enterSection(selectionIndex)
            elseif mode=="ELEMENTS" then
                local els=currentSection:_getVisibleElements()
                local el=els[selectionIndex]
                if not el then return end
                if el.Type=="Button" then
                    task.spawn(el.Callback)
                elseif el.Type=="Toggle" then
                    el:Set(not el.Value)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                elseif el.Type=="Dropdown" then
                    openDropdown(el,selectionIndex)
                end
            elseif mode=="DROPDOWN" then
                local dd=dropdownState
                if not dd then return end
                local optIdx=clamp(selectionIndex-1,1,#(dd.element.Options))
                dd.element:SetIndex(optIdx)
                closeDropdown()
            end
        elseif input.KeyCode==Enum.KeyCode.Backspace then
            if mode=="DROPDOWN" then
                closeDropdown()
            else
                popHistory()
                if not currentSection then
                    renderSections()
                else
                    renderElements(currentSection)
                end
                applyHighlight()
            end
        end
    end)

    -- Funzioni
    local function enterSection(idx)
        currentSection=sections[idx]
        if not currentSection then return end
        pushHistory()
        renderElements(currentSection)
    end

    local function renderSections()
        clearList()
        mode="SECTIONS"
        currentSection=nil
        dropdownState=nil
        for i,sec in ipairs(sections) do
            local row=createRow(i)
            row.Frame.Name="Section_"..sec.Name
            row.Title.Text=sec.Name
            row.Right.Text="→"
            row.Button.MouseButton1Click:Connect(function()
                selectionIndex=i
                applyHighlight()
                enterSection(i)
            end)
        end
        if #sections==0 then return end
        if selectionIndex<1 then selectionIndex=1 end
        if selectionIndex>#sections then selectionIndex=#sections end
        applyHighlight()
    end

    local function renderElements(section)
        clearList()
        mode="ELEMENTS"
        currentSection=section
        dropdownState=nil
        local visibleElements=section:_getVisibleElements()
        for i,el in ipairs(visibleElements) do
            local row=createRow(i)
            row.Frame.Name="Element_"..el.Id
            row.Title.Text=el.Text
            if el.Type=="Label" then
                row.Right.Text=""
                row.Button.Active=false
                row.Button.Selectable=false
                row.Title.TextColor3=Theme.MutedText
            elseif el.Type=="Button" then
                row.Right.Text="→"
                row.Button.MouseButton1Click:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    el:Activate()
                end)
            elseif el.Type=="Toggle" then
                row.Right.Text=el.Value and "ON" or "OFF"
                row.Right.TextColor3=el.Value and Theme.Text or Theme.MutedText
                row.Button.MouseButton1Click:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    el:Set(not el.Value)
                    row.Right.Text=el.Value and "ON" or "OFF"
                    row.Right.TextColor3=el.Value and Theme.Text or Theme.MutedText
                end)
            elseif el.Type=="Slider" then
                row.Right.Text=tostring(el.Value)
                local barWrap=create("Frame",{
                    Size=UDim2.new(1,-180,0,10),
                    Position=UDim2.new(0,14,1,-14),
                    BackgroundTransparency=1,
                })
                barWrap.Parent=row.Frame
                local track=create("Frame",{
                    Size=UDim2.new(1,0,1,0),
                    BackgroundColor3=Theme.SliderTrack,
                    BackgroundTransparency=0.2,
                    BorderSizePixel=0,
                })
                track.Parent=barWrap
                create("UICorner",{CornerRadius=UDim.new(0,8),Parent=track})
                local fill=create("Frame",{
                    Size=UDim2.new(0,0,1,0),
                    BackgroundColor3=Theme.SliderFill,
                    BackgroundTransparency=0.05,
                    BorderSizePixel=0,
                })
                fill.Parent=track
                create("UICorner",{CornerRadius=UDim.new(0,8),Parent=fill})

                local function updateFill()
                    local pct=0
                    if el.Max>el.Min then
                        pct=(el.Value - el.Min)/(el.Max-el.Min)
                    end
                    pct=clamp(pct,0,1)
                    fill.Size=UDim2.new(pct,0,1,0)
                    row.Right.Text=tostring(el.Value)
                end
                updateFill()

                local dragging=false
                local function setFromMouse()
                    local mouseX=game:GetService("UserInputService"):GetMouseLocation().X
                    local absPos=track.AbsolutePosition
                    local absSize=track.AbsoluteSize
                    local x=clamp(mouseX - absPos.X,0,absSize.X)
                    local pct = (absSize.X>0) and (x/absSize.X) or 0
                    local raw=el.Min+(el.Max - el.Min)*pct
                    local v=roundToStep(raw,el.Step)
                    el:Set(v)
                    updateFill()
                end

                row.Button.MouseButton1Down:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    dragging=true
                    setFromMouse()
                end)

                game:GetService("UserInputService").InputEnded:Connect(function(input)
                    if input.UserInputType==Enum.UserInputType.MouseButton1 then
                        dragging=false
                    end
                end)

                game:GetService("UserInputService").InputChanged:Connect(function(input,gpe)
                    if gpe then return end
                    if dragging and input.UserInputType==Enum.UserInputType.MouseMovement then
                        setFromMouse()
                    end
                end)

                el._uiUpdate=updateFill
            elseif el.Type=="Dropdown" then
                row.Right.Text=el.Options[el.ValueIndex] or ""
                row.Button.MouseButton1Click:Connect(function()
                    openDropdown(el,i)
                end)
            end
        end
        if selectionIndex<1 then selectionIndex=1 end
        if selectionIndex>#visibleElements then selectionIndex=#visibleElements end
        applyHighlight()
    end

    local function renderDropdown(el,parentIdx)
        clearList()
        mode="DROPDOWN"
        dropdownState={
            element=el,
            parentIndex=parentIdx,
            selectionIndex=el.ValueIndex or 1,
        }
        local header=createRow(1,true)
        header.Title.Text=el.Text.." (Select)"
        header.Right.Text=""
        header.Button.Active=false
        header.Button.Selectable=false
        header.Title.TextColor3=Theme.MutedText
        header.Frame.Parent=list

        for i,opt in ipairs(el.Options) do
            local row=createRow(i+1)
            row.Frame.Parent=list
            row.Title.Text=tostring(opt)
            row.Right.Text=(i==(el.ValueIndex or 1)) and "✓" or ""
            row.Button.MouseButton1Click:Connect(function()
                dropdownState.selectionIndex=i
                applyHighlight()
                el:SetIndex(i)
                closeDropdown()
            end)
        end
        selectionIndex=math.clamp((dropdownState.selectionIndex or 1)+1,2,#el.Options+1)
        applyHighlight()
    end

    local function openDropdown(e,pIdx)
        pushHistory()
        tween(root, TweenSlow, {BackgroundTransparency=Theme.PanelBgTransparency})
        renderDropdown(e,pIdx)
    end

    local function closeDropdown()
        local dd=dropdownState
        if not dd then
            enterSection(selectionIndex)
            return
        end
        local el=dd.element
        local pIdx=dd.parentIndex
        tween(root, TweenSlow, {BackgroundTransparency=Theme.PanelBgTransparency})
        enterSection(currentSection)
        selectionIndex=pIdx
        applyHighlight()
        popHistory()
    end

    -- Input
    local inputConn
    inputConn = game:GetService("UserInputService").InputBegan:Connect(function(input,gpe)
        if gpe or destroyed then return end
        if input.KeyCode==Enum.KeyCode.F8 then
            root.Visible=not root.Visible
        end
        if not root.Visible then return end
        if input.KeyCode==Enum.KeyCode.KeypadEight then
            if mode=="DROPDOWN" then
                selectionIndex=math.clamp(selectionIndex-1,2,#(dropdownState.element.Options)+1)
            else
                selectionIndex=selectionIndex-1
                if mode=="SECTIONS" then
                    selectionIndex=math.clamp(selectionIndex,1,#sections)
                else
                    selectionIndex=math.clamp(selectionIndex,1,#(currentSection:_getVisibleElements()))
                end
            end
            applyHighlight()
        elseif input.KeyCode==Enum.KeyCode.KeypadTwo then
            if mode=="DROPDOWN" then
                selectionIndex=math.clamp(selectionIndex+1,2,#(dropdownState.element.Options)+1)
            else
                selectionIndex=selectionIndex+1
                if mode=="SECTIONS" then
                    selectionIndex=math.clamp(selectionIndex,1,#sections)
                else
                    selectionIndex=math.clamp(selectionIndex,1,#(currentSection:_getVisibleElements()))
                end
            end
            applyHighlight()
        elseif input.KeyCode==Enum.KeyCode.KeypadFour then
            if mode=="ELEMENTS" then
                local els=currentSection:_getVisibleElements()
                local el=els[selectionIndex]
                if not el then return end
                if el.Type=="Slider" then
                    el:Set(el.Value - el.Step)
                    if el._uiUpdate then el._uiUpdate() end
                elseif el.Type=="Toggle" then
                    el:Set(false)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                elseif el.Type=="Dropdown" then
                    el:SetIndex((el.ValueIndex or 1)-1)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                end
            elseif mode=="DROPDOWN" then
                selectionIndex=math.clamp(selectionIndex-1,2,#(dropdownState.element.Options)+1)
                applyHighlight()
            end
        elseif input.KeyCode==Enum.KeyCode.KeypadSix then
            if mode=="ELEMENTS" then
                local els=currentSection:_getVisibleElements()
                local el=els[selectionIndex]
                if not el then return end
                if el.Type=="Slider" then
                    el:Set(el.Value + el.Step)
                    if el._uiUpdate then el._uiUpdate() end
                elseif el.Type=="Toggle" then
                    el:Set(true)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                elseif el.Type=="Dropdown" then
                    el:SetIndex((el.ValueIndex or 1)+1)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                end
            elseif mode=="DROPDOWN" then
                selectionIndex=math.clamp(selectionIndex+1,2,#(dropdownState.element.Options)+1)
                applyHighlight()
            end
        elseif input.KeyCode==Enum.KeyCode.Return or input.KeyCode==Enum.KeyCode.KeypadEnter then
            if mode=="SECTIONS" then
                enterSection(selectionIndex)
            elseif mode=="ELEMENTS" then
                local els=currentSection:_getVisibleElements()
                local el=els[selectionIndex]
                if not el then return end
                if el.Type=="Button" then
                    task.spawn(el.Callback)
                elseif el.Type=="Toggle" then
                    el:Set(not el.Value)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                elseif el.Type=="Dropdown" then
                    openDropdown(el,selectionIndex)
                end
            elseif mode=="DROPDOWN" then
                local dd=dropdownState
                if not dd then return end
                local optIdx=clamp(selectionIndex-1,1,#(dd.element.Options))
                dd.element:SetIndex(optIdx)
                closeDropdown()
            end
        elseif input.KeyCode==Enum.KeyCode.Backspace then
            if mode=="DROPDOWN" then
                closeDropdown()
            else
                popHistory()
                if not currentSection then
                    renderSections()
                else
                    renderElements(currentSection)
                end
                applyHighlight()
            end
        end
    end)

    -- Vari funzioni
    local function enterSection(idx)
        currentSection=sections[idx]
        if not currentSection then return end
        pushHistory()
        renderElements(currentSection)
    end

    local function renderSections()
        clearList()
        mode="SECTIONS"
        currentSection=nil
        dropdownState=nil
        for i,sec in ipairs(sections) do
            local row=createRow(i)
            row.Frame.Name="Section_"..sec.Name
            row.Title.Text=sec.Name
            row.Right.Text="→"
            row.Button.MouseButton1Click:Connect(function()
                selectionIndex=i
                applyHighlight()
                enterSection(i)
            end)
        end
        if #sections==0 then return end
        if selectionIndex<1 then selectionIndex=1 end
        if selectionIndex>#sections then selectionIndex=#sections end
        applyHighlight()
    end

    local function renderElements(section)
        clearList()
        mode="ELEMENTS"
        currentSection=section
        dropdownState=nil
        local visibleElements=section:_getVisibleElements()
        for i,el in ipairs(visibleElements) do
            local row=createRow(i)
            row.Frame.Name="Element_"..el.Id
            row.Title.Text=el.Text
            if el.Type=="Label" then
                row.Right.Text=""
                row.Button.Active=false
                row.Button.Selectable=false
                row.Title.TextColor3=Theme.MutedText
            elseif el.Type=="Button" then
                row.Right.Text="→"
                row.Button.MouseButton1Click:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    el:Activate()
                end)
            elseif el.Type=="Toggle" then
                row.Right.Text=el.Value and "ON" or "OFF"
                row.Right.TextColor3=el.Value and Theme.Text or Theme.MutedText
                row.Button.MouseButton1Click:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    el:Set(not el.Value)
                    row.Right.Text=el.Value and "ON" or "OFF"
                    row.Right.TextColor3=el.Value and Theme.Text or Theme.MutedText
                end)
            elseif el.Type=="Slider" then
                row.Right.Text=tostring(el.Value)
                local barWrap=create("Frame",{
                    Size=UDim2.new(1,-180,0,10),
                    Position=UDim2.new(0,14,1,-14),
                    BackgroundTransparency=1,
                })
                barWrap.Parent=row.Frame
                local track=create("Frame",{
                    Size=UDim2.new(1,0,1,0),
                    BackgroundColor3=Theme.SliderTrack,
                    BackgroundTransparency=0.2,
                    BorderSizePixel=0,
                })
                track.Parent=barWrap
                create("UICorner",{CornerRadius=UDim.new(0,8),Parent=track})
                local fill=create("Frame",{
                    Size=UDim2.new(0,0,1,0),
                    BackgroundColor3=Theme.SliderFill,
                    BackgroundTransparency=0.05,
                    BorderSizePixel=0,
                })
                fill.Parent=track
                create("UICorner",{CornerRadius=UDim.new(0,8),Parent=fill})

                local function updateFill()
                    local pct=0
                    if el.Max>el.Min then
                        pct=(el.Value - el.Min)/(el.Max-el.Min)
                    end
                    pct=clamp(pct,0,1)
                    fill.Size=UDim2.new(pct,0,1,0)
                    row.Right.Text=tostring(el.Value)
                end
                updateFill()

                local dragging=false
                local function setFromMouse()
                    local mouseX=game:GetService("UserInputService"):GetMouseLocation().X
                    local absPos=track.AbsolutePosition
                    local absSize=track.AbsoluteSize
                    local x=clamp(mouseX - absPos.X,0,absSize.X)
                    local pct = (absSize.X>0) and (x/absSize.X) or 0
                    local raw=el.Min+(el.Max - el.Min)*pct
                    local v=roundToStep(raw,el.Step)
                    el:Set(v)
                    updateFill()
                end

                row.Button.MouseButton1Down:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    dragging=true
                    setFromMouse()
                end)

                game:GetService("UserInputService").InputEnded:Connect(function(input)
                    if input.UserInputType==Enum.UserInputType.MouseButton1 then
                        dragging=false
                    end
                end)

                game:GetService("UserInputService").InputChanged:Connect(function(input,gpe)
                    if gpe then return end
                    if dragging and input.UserInputType==Enum.UserInputType.MouseMovement then
                        setFromMouse()
                    end
                end)

                el._uiUpdate=updateFill
            elseif el.Type=="Dropdown" then
                row.Right.Text=el.Options[el.ValueIndex] or ""
                row.Button.MouseButton1Click:Connect(function()
                    openDropdown(el,i)
                end)
            end
        end
        if selectionIndex<1 then selectionIndex=1 end
        if selectionIndex>#visibleElements then selectionIndex=#visibleElements end
        applyHighlight()
    end

    local function renderDropdown(el,pIdx)
        clearList()
        mode="DROPDOWN"
        dropdownState={
            element=el,
            parentIndex=pIdx,
            selectionIndex=el.ValueIndex or 1,
        }
        local header=createRow(1,true)
        header.Title.Text=el.Text.." (Select)"
        header.Right.Text=""
        header.Button.Active=false
        header.Button.Selectable=false
        header.Title.TextColor3=Theme.MutedText
        header.Frame.Parent=list

        for i,opt in ipairs(el.Options) do
            local row=createRow(i+1)
            row.Frame.Parent=list
            row.Title.Text=tostring(opt)
            row.Right.Text=(i==(el.ValueIndex or 1)) and "✓" or ""
            row.Button.MouseButton1Click:Connect(function()
                dropdownState.selectionIndex=i
                applyHighlight()
                el:SetIndex(i)
                closeDropdown()
            end)
        end
        selectionIndex=math.clamp((dropdownState.selectionIndex or 1)+1,2,#el.Options+1)
        applyHighlight()
    end

    local function openDropdown(e,pIdx)
        pushHistory()
        tween(root, TweenSlow, {BackgroundTransparency=Theme.PanelBgTransparency})
        renderDropdown(e,pIdx)
    end

    local function closeDropdown()
        local dd=dropdownState
        if not dd then
            enterSection(selectionIndex)
            return
        end
        local el=dd.element
        local pIdx=dd.parentIndex
        tween(root, TweenSlow, {BackgroundTransparency=Theme.PanelBgTransparency})
        enterSection(currentSection)
        selectionIndex=pIdx
        applyHighlight()
        popHistory()
    end

    -- Controllo input
    local inputConn
    inputConn=game:GetService("UserInputService").InputBegan:Connect(function(input,gpe)
        if gpe or destroyed then return end
        if input.KeyCode==Enum.KeyCode.F8 then
            root.Visible=not root.Visible
        end
        if not root.Visible then return end
        if input.KeyCode==Enum.KeyCode.KeypadEight then
            if mode=="DROPDOWN" then
                selectionIndex=math.clamp(selectionIndex-1,2,#(dropdownState.element.Options)+1)
            else
                selectionIndex=selectionIndex-1
                if mode=="SECTIONS" then
                    selectionIndex=math.clamp(selectionIndex,1,#sections)
                else
                    selectionIndex=math.clamp(selectionIndex,1,#(currentSection:_getVisibleElements()))
                end
            end
            applyHighlight()
        elseif input.KeyCode==Enum.KeyCode.KeypadTwo then
            if mode=="DROPDOWN" then
                selectionIndex=math.clamp(selectionIndex+1,2,#(dropdownState.element.Options)+1)
            else
                selectionIndex=selectionIndex+1
                if mode=="SECTIONS" then
                    selectionIndex=math.clamp(selectionIndex,1,#sections)
                else
                    selectionIndex=math.clamp(selectionIndex,1,#(currentSection:_getVisibleElements()))
                end
            end
            applyHighlight()
        elseif input.KeyCode==Enum.KeyCode.KeypadFour then
            if mode=="ELEMENTS" then
                local els=currentSection:_getVisibleElements()
                local el=els[selectionIndex]
                if not el then return end
                if el.Type=="Slider" then
                    el:Set(el.Value - el.Step)
                    if el._uiUpdate then el._uiUpdate() end
                elseif el.Type=="Toggle" then
                    el:Set(false)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                elseif el.Type=="Dropdown" then
                    el:SetIndex((el.ValueIndex or 1)-1)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                end
            elseif mode=="DROPDOWN" then
                selectionIndex=math.clamp(selectionIndex-1,2,#(dropdownState.element.Options)+1)
                applyHighlight()
            end
        elseif input.KeyCode==Enum.KeyCode.KeypadSix then
            if mode=="ELEMENTS" then
                local els=currentSection:_getVisibleElements()
                local el=els[selectionIndex]
                if not el then return end
                if el.Type=="Slider" then
                    el:Set(el.Value + el.Step)
                    if el._uiUpdate then el._uiUpdate() end
                elseif el.Type=="Toggle" then
                    el:Set(true)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                elseif el.Type=="Dropdown" then
                    el:SetIndex((el.ValueIndex or 1)+1)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                end
            elseif mode=="DROPDOWN" then
                selectionIndex=math.clamp(selectionIndex+1,2,#(dropdownState.element.Options)+1)
                applyHighlight()
            end
        elseif input.KeyCode==Enum.KeyCode.Return or input.KeyCode==Enum.KeyCode.KeypadEnter then
            if mode=="SECTIONS" then
                enterSection(selectionIndex)
            elseif mode=="ELEMENTS" then
                local els=currentSection:_getVisibleElements()
                local el=els[selectionIndex]
                if not el then return end
                if el.Type=="Button" then
                    task.spawn(el.Callback)
                elseif el.Type=="Toggle" then
                    el:Set(not el.Value)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                elseif el.Type=="Dropdown" then
                    openDropdown(el,selectionIndex)
                end
            elseif mode=="DROPDOWN" then
                local dd=dropdownState
                if not dd then return end
                local optIdx=clamp(selectionIndex-1,1,#(dd.element.Options))
                dd.element:SetIndex(optIdx)
                closeDropdown()
            end
        elseif input.KeyCode==Enum.KeyCode.Backspace then
            if mode=="DROPDOWN" then
                closeDropdown()
            else
                popHistory()
                if not currentSection then
                    renderSections()
                else
                    renderElements(currentSection)
                end
                applyHighlight()
            end
        end
    end)

    -- Funzioni
    local function pushHistory()
        table.insert(history, {
            mode=mode,
            section=currentSection,
            selection=selectionIndex,
            dropdown=dropdownState,
        })
    end

    local function popHistory()
        local last=table.remove(history)
        if not last then return end
        mode=last.mode
        currentSection=last.section
        selectionIndex=last.selection
        dropdownState=last.dropdown
    end

    local function enterSection(idx)
        currentSection=sections[idx]
        if not currentSection then return end
        pushHistory()
        renderElements(currentSection)
    end

    local function renderSections()
        clearList()
        mode="SECTIONS"
        currentSection=nil
        dropdownState=nil
        for i,sec in ipairs(sections) do
            local row=createRow(i)
            row.Frame.Name="Section_"..sec.Name
            row.Title.Text=sec.Name
            row.Right.Text="→"
            row.Button.MouseButton1Click:Connect(function()
                selectionIndex=i
                applyHighlight()
                enterSection(i)
            end)
        end
        if #sections==0 then return end
        if selectionIndex<1 then selectionIndex=1 end
        if selectionIndex>#sections then selectionIndex=#sections end
        applyHighlight()
    end

    local function renderElements(section)
        clearList()
        mode="ELEMENTS"
        currentSection=section
        dropdownState=nil
        local visibleElements=section:_getVisibleElements()
        for i,el in ipairs(visibleElements) do
            local row=createRow(i)
            row.Frame.Name="Element_"..el.Id
            row.Title.Text=el.Text
            if el.Type=="Label" then
                row.Right.Text=""
                row.Button.Active=false
                row.Button.Selectable=false
                row.Title.TextColor3=Theme.MutedText
            elseif el.Type=="Button" then
                row.Right.Text="→"
                row.Button.MouseButton1Click:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    el:Activate()
                end)
            elseif el.Type=="Toggle" then
                row.Right.Text=el.Value and "ON" or "OFF"
                row.Right.TextColor3=el.Value and Theme.Text or Theme.MutedText
                row.Button.MouseButton1Click:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    el:Set(not el.Value)
                    row.Right.Text=el.Value and "ON" or "OFF"
                    row.Right.TextColor3=el.Value and Theme.Text or Theme.MutedText
                end)
            elseif el.Type=="Slider" then
                row.Right.Text=tostring(el.Value)
                local barWrap=create("Frame",{
                    Size=UDim2.new(1,-180,0,10),
                    Position=UDim2.new(0,14,1,-14),
                    BackgroundTransparency=1,
                })
                barWrap.Parent=row.Frame
                local track=create("Frame",{
                    Size=UDim2.new(1,0,1,0),
                    BackgroundColor3=Theme.SliderTrack,
                    BackgroundTransparency=0.2,
                    BorderSizePixel=0,
                })
                track.Parent=barWrap
                create("UICorner",{CornerRadius=UDim.new(0,8),Parent=track})
                local fill=create("Frame",{
                    Size=UDim2.new(0,0,1,0),
                    BackgroundColor3=Theme.SliderFill,
                    BackgroundTransparency=0.05,
                    BorderSizePixel=0,
                })
                fill.Parent=track
                create("UICorner",{CornerRadius=UDim.new(0,8),Parent=fill})

                local function updateFill()
                    local pct=0
                    if el.Max>el.Min then
                        pct=(el.Value - el.Min)/(el.Max-el.Min)
                    end
                    pct=clamp(pct,0,1)
                    fill.Size=UDim2.new(pct,0,1,0)
                    row.Right.Text=tostring(el.Value)
                end
                updateFill()

                local dragging=false
                local function setFromMouse()
                    local mouseX=game:GetService("UserInputService"):GetMouseLocation().X
                    local absPos=track.AbsolutePosition
                    local absSize=track.AbsoluteSize
                    local x=clamp(mouseX - absPos.X,0,absSize.X)
                    local pct = (absSize.X>0) and (x/absSize.X) or 0
                    local raw=el.Min+(el.Max - el.Min)*pct
                    local v=roundToStep(raw,el.Step)
                    el:Set(v)
                    updateFill()
                end

                row.Button.MouseButton1Down:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    dragging=true
                    setFromMouse()
                end)

                game:GetService("UserInputService").InputEnded:Connect(function(input)
                    if input.UserInputType==Enum.UserInputType.MouseButton1 then
                        dragging=false
                    end
                end)

                game:GetService("UserInputService").InputChanged:Connect(function(input,gpe)
                    if gpe then return end
                    if dragging and input.UserInputType==Enum.UserInputType.MouseMovement then
                        setFromMouse()
                    end
                end)

                el._uiUpdate=updateFill
            elseif el.Type=="Dropdown" then
                row.Right.Text=el.Options[el.ValueIndex] or ""
                row.Button.MouseButton1Click:Connect(function()
                    openDropdown(el,i)
                end)
            end
        end
        if selectionIndex<1 then selectionIndex=1 end
        if selectionIndex>#visibleElements then selectionIndex=#visibleElements end
        applyHighlight()
    end

    local function renderDropdown(e,pIdx)
        clearList()
        mode="DROPDOWN"
        dropdownState={
            element=e,
            parentIndex=pIdx,
            selectionIndex=e.ValueIndex or 1,
        }
        local header=createRow(1,true)
        header.Title.Text=e.Text.." (Select)"
        header.Right.Text=""
        header.Button.Active=false
        header.Button.Selectable=false
        header.Title.TextColor3=Theme.MutedText
        header.Frame.Parent=list

        for i,opt in ipairs(e.Options) do
            local row=createRow(i+1)
            row.Frame.Parent=list
            row.Title.Text=tostring(opt)
            row.Right.Text=(i==(e.ValueIndex or 1)) and "✓" or ""
            row.Button.MouseButton1Click:Connect(function()
                dropdownState.selectionIndex=i
                applyHighlight()
                e:SetIndex(i)
                closeDropdown()
            end)
        end
        selectionIndex=math.clamp((dropdownState.selectionIndex or 1)+1,2,#e.Options+1)
        applyHighlight()
    end

    local function openDropdown(e,pIdx)
        pushHistory()
        tween(root, TweenSlow, {BackgroundTransparency=Theme.PanelBgTransparency})
        renderDropdown(e,pIdx)
    end

    local function closeDropdown()
        local dd=dropdownState
        if not dd then
            enterSection(selectionIndex)
            return
        end
        local el=dd.element
        local pIdx=dd.parentIndex
        tween(root, TweenSlow, {BackgroundTransparency=Theme.PanelBgTransparency})
        enterSection(currentSection)
        selectionIndex=pIdx
        applyHighlight()
        popHistory()
    end

    -- Input
    local inputConn
    inputConn=game:GetService("UserInputService").InputBegan:Connect(function(input,gpe)
        if gpe or destroyed then return end
        if input.KeyCode==Enum.KeyCode.F8 then
            root.Visible=not root.Visible
        end
        if not root.Visible then return end
        if input.KeyCode==Enum.KeyCode.KeypadEight then
            if mode=="DROPDOWN" then
                selectionIndex=math.clamp(selectionIndex-1,2,#(dropdownState.element.Options)+1)
            else
                selectionIndex=selectionIndex-1
                if mode=="SECTIONS" then
                    selectionIndex=math.clamp(selectionIndex,1,#sections)
                else
                    selectionIndex=math.clamp(selectionIndex,1,#(currentSection:_getVisibleElements()))
                end
            end
            applyHighlight()
        elseif input.KeyCode==Enum.KeyCode.KeypadTwo then
            if mode=="DROPDOWN" then
                selectionIndex=math.clamp(selectionIndex+1,2,#(dropdownState.element.Options)+1)
            else
                selectionIndex=selectionIndex+1
                if mode=="SECTIONS" then
                    selectionIndex=math.clamp(selectionIndex,1,#sections)
                else
                    selectionIndex=math.clamp(selectionIndex,1,#(currentSection:_getVisibleElements()))
                end
            end
            applyHighlight()
        elseif input.KeyCode==Enum.KeyCode.KeypadFour then
            if mode=="ELEMENTS" then
                local els=currentSection:_getVisibleElements()
                local el=els[selectionIndex]
                if not el then return end
                if el.Type=="Slider" then
                    el:Set(el.Value - el.Step)
                    if el._uiUpdate then el._uiUpdate() end
                elseif el.Type=="Toggle" then
                    el:Set(false)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                elseif el.Type=="Dropdown" then
                    el:SetIndex((el.ValueIndex or 1)-1)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                end
            elseif mode=="DROPDOWN" then
                selectionIndex=math.clamp(selectionIndex-1,2,#(dropdownState.element.Options)+1)
                applyHighlight()
            end
        elseif input.KeyCode==Enum.KeyCode.KeypadSix then
            if mode=="ELEMENTS" then
                local els=currentSection:_getVisibleElements()
                local el=els[selectionIndex]
                if not el then return end
                if el.Type=="Slider" then
                    el:Set(el.Value + el.Step)
                    if el._uiUpdate then el._uiUpdate() end
                elseif el.Type=="Toggle" then
                    el:Set(true)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                elseif el.Type=="Dropdown" then
                    el:SetIndex((el.ValueIndex or 1)+1)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                end
            elseif mode=="DROPDOWN" then
                selectionIndex=math.clamp(selectionIndex+1,2,#(dropdownState.element.Options)+1)
                applyHighlight()
            end
        elseif input.KeyCode==Enum.KeyCode.Return or input.KeyCode==Enum.KeyCode.KeypadEnter then
            if mode=="SECTIONS" then
                enterSection(selectionIndex)
            elseif mode=="ELEMENTS" then
                local els=currentSection:_getVisibleElements()
                local el=els[selectionIndex]
                if not el then return end
                if el.Type=="Button" then
                    task.spawn(el.Callback)
                elseif el.Type=="Toggle" then
                    el:Set(not el.Value)
                    renderElements(currentSection)
                    selectionIndex=math.clamp(selectionIndex,1,#els)
                    applyHighlight()
                elseif el.Type=="Dropdown" then
                    openDropdown(el,selectionIndex)
                end
            elseif mode=="DROPDOWN" then
                local dd=dropdownState
                if not dd then return end
                local optIdx=clamp(selectionIndex-1,1,#(dd.element.Options))
                dd.element:SetIndex(optIdx)
                closeDropdown()
            end
        elseif input.KeyCode==Enum.KeyCode.Backspace then
            if mode=="DROPDOWN" then
                closeDropdown()
            else
                popHistory()
                if not currentSection then
                    renderSections()
                else
                    renderElements(currentSection)
                end
                applyHighlight()
            end
        end
    end)

    -- Funzioni interne
    local function pushHistory()
        table.insert(history, {
            mode=mode,
            section=currentSection,
            selection=selectionIndex,
            dropdown=dropdownState,
        })
    end

    local function popHistory()
        local last=table.remove(history)
        if not last then return end
        mode=last.mode
        currentSection=last.section
        selectionIndex=last.selection
        dropdownState=last.dropdown
    end

    local function enterSection(idx)
        currentSection=sections[idx]
        if not currentSection then return end
        pushHistory()
        renderElements(currentSection)
    end

    local function renderSections()
        clearList()
        mode="SECTIONS"
        currentSection=nil
        dropdownState=nil
        for i,sec in ipairs(sections) do
            local row=createRow(i)
            row.Frame.Name="Section_"..sec.Name
            row.Title.Text=sec.Name
            row.Right.Text="→"
            row.Button.MouseButton1Click:Connect(function()
                selectionIndex=i
                applyHighlight()
                enterSection(i)
            end)
        end
        if #sections==0 then return end
        if selectionIndex<1 then selectionIndex=1 end
        if selectionIndex>#sections then selectionIndex=#sections end
        applyHighlight()
    end

    local function renderElements(section)
        clearList()
        mode="ELEMENTS"
        currentSection=section
        dropdownState=nil
        local visibleElements=section:_getVisibleElements()
        for i,el in ipairs(visibleElements) do
            local row=createRow(i)
            row.Frame.Name="Element_"..el.Id
            row.Title.Text=el.Text
            if el.Type=="Label" then
                row.Right.Text=""
                row.Button.Active=false
                row.Button.Selectable=false
                row.Title.TextColor3=Theme.MutedText
            elseif el.Type=="Button" then
                row.Right.Text="→"
                row.Button.MouseButton1Click:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    el:Activate()
                end)
            elseif el.Type=="Toggle" then
                row.Right.Text=el.Value and "ON" or "OFF"
                row.Right.TextColor3=el.Value and Theme.Text or Theme.MutedText
                row.Button.MouseButton1Click:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    el:Set(not el.Value)
                    row.Right.Text=el.Value and "ON" or "OFF"
                    row.Right.TextColor3=el.Value and Theme.Text or Theme.MutedText
                end)
            elseif el.Type=="Slider" then
                row.Right.Text=tostring(el.Value)
                local barWrap=create("Frame",{
                    Size=UDim2.new(1,-180,0,10),
                    Position=UDim2.new(0,14,1,-14),
                    BackgroundTransparency=1,
                })
                barWrap.Parent=row.Frame
                local track=create("Frame",{
                    Size=UDim2.new(1,0,1,0),
                    BackgroundColor3=Theme.SliderTrack,
                    BackgroundTransparency=0.2,
                    BorderSizePixel=0,
                })
                track.Parent=barWrap
                create("UICorner",{CornerRadius=UDim.new(0,8),Parent=track})
                local fill=create("Frame",{
                    Size=UDim2.new(0,0,1,0),
                    BackgroundColor3=Theme.SliderFill,
                    BackgroundTransparency=0.05,
                    BorderSizePixel=0,
                })
                fill.Parent=track
                create("UICorner",{CornerRadius=UDim.new(0,8),Parent=fill})

                local function updateFill()
                    local pct=0
                    if el.Max>el.Min then
                        pct=(el.Value - el.Min)/(el.Max-el.Min)
                    end
                    pct=clamp(pct,0,1)
                    fill.Size=UDim2.new(pct,0,1,0)
                    row.Right.Text=tostring(el.Value)
                end
                updateFill()

                local dragging=false
                local function setFromMouse()
                    local mouseX=game:GetService("UserInputService"):GetMouseLocation().X
                    local absPos=track.AbsolutePosition
                    local absSize=track.AbsoluteSize
                    local x=clamp(mouseX - absPos.X,0,absSize.X)
                    local pct = (absSize.X>0) and (x/absSize.X) or 0
                    local raw=el.Min+(el.Max - el.Min)*pct
                    local v=roundToStep(raw,el.Step)
                    el:Set(v)
                    updateFill()
                end

                row.Button.MouseButton1Down:Connect(function()
                    selectionIndex=i
                    applyHighlight()
                    dragging=true
                    setFromMouse()
                end)

                game:GetService("UserInputService").InputEnded:Connect(function(input)
                    if input.UserInputType==Enum.UserInputType.MouseButton1 then
                        dragging=false
                    end
                end)

                game:GetService("UserInputService").InputChanged:Connect(function(input,gpe)
                    if gpe then return end
                    if dragging and input.UserInputType==Enum.UserInputType.MouseMovement then
                        setFromMouse()
                    end
                end)

                el._uiUpdate=updateFill
            elseif el.Type=="Dropdown" then
                row.Right.Text=el.Options[el.ValueIndex] or ""
                row.Button.MouseButton1Click:Connect(function()
                    openDropdown(el,i)
                end)
            end
        end
        if selectionIndex<1 then selectionIndex=1 end
        if selectionIndex>#visibleElements then selectionIndex=#visibleElements end
        applyHighlight()
    end

    local function renderDropdown(e,pIdx)
        clearList()
        mode="DROPDOWN"
        dropdownState={
            element=e,
            parentIndex=pIdx,
            selectionIndex=e.ValueIndex or 1,
        }
        local header=createRow(1,true)
        header.Title.Text=e.Text.." (Select)"
        header.Right.Text=""
        header.Button.Active=false
        header.Button.Selectable=false
        header.Title.TextColor3=Theme.MutedText
        header.Frame.Parent=list

        for i,opt in ipairs(e.Options) do
            local row=createRow(i+1)
            row.Frame.Parent=list
            row.Title.Text=tostring(opt)
            row.Right.Text=(i==(e.ValueIndex or 1)) and "✓" or ""
            row.Button.MouseButton1Click:Connect(function()
                dropdownState.selectionIndex=i
                applyHighlight()
                e:SetIndex(i)
                closeDropdown()
            end)
        end
        selectionIndex=math.clamp((dropdownState.selectionIndex or 1)+1,2,#e.Options+1)
        applyHighlight()
    end

    local function openDropdown(e,pIdx)
        pushHistory()
        tween(root, TweenSlow, {BackgroundTransparency=Theme.PanelBgTransparency})
        renderDropdown(e,pIdx)
    end

    local function closeDropdown()
        local dd=dropdownState
        if not dd then
            enterSection(selectionIndex)
            return
        end
        local el=dd.element
        local pIdx=dd.parentIndex
        tween(root, TweenSlow, {BackgroundTransparency=Theme.PanelBgTransparency})
        enterSection(currentSection)
        selectionIndex=pIdx
        applyHighlight()
        popHistory()
    end

    -- Riferimenti alle sezioni (da aggiungere tu)
    local sections = {} -- Qui devi creare le sezioni con le funzioni sotto
    local sectionsNames = {"Main", "Visuals"}
    local sectionsObjects = {}
    for _,name in ipairs(sectionsNames) do
        local sec = {}
        sec.Name=name
        sec._window=nil -- da assegnare dopo
        sec._elements={}
        sec._nextId=0
        table.insert(sections,sec)
    end

    -- esempio di aggiunta di sezioni e elementi:
    local function addSection(name)
        local sec = {}
        sec.Name=name
        sec._window=nil
        sec._elements={}
        sec._nextId=0
        table.insert(sections,sec)
        return sec
    end

    -- esempio di aggiunta di elemento in una sezione
    local function addButton(sec,name,callback)
        local el = {}
        el.Type="Button"
        el.Text=name
        el.Callback=callback
        table.insert(sec._elements,el)
    end

    local function addToggle(sec,name,default,callback)
        local el = {}
        el.Type="Toggle"
        el.Text=name
        el.Value=default
        el.Callback=callback
        table.insert(sec._elements,el)
    end

    local function addSlider(sec,name,min,max,step,default,callback)
        local el = {}
        el.Type="Slider"
        el.Text=name
        el.Min=min
        el.Max=max
        el.Step=step
        el.Value=default
        el.Callback=callback
        table.insert(sec._elements,el)
    end

    local function addDropdown(sec,name,options,defaultIndex,callback)
        local el={}
        el.Type="Dropdown"
        el.Text=name
        el.Options=options
        el.ValueIndex=defaultIndex
        el.Callback=callback
        table.insert(sec._elements,el)
    end

    -- assegnare le funzioni alle sezioni
    for _,sec in ipairs(sections) do
        sec._window= { _elements=sec._elements }
    end

    -- Aggiungi sezioni
    local mainSec=addSection("Main")
    local visualSec=addSection("Visuals")

    -- Aggiungi elementi esempio
    addButton(mainSec,"Hello",function() print("Ciao!") end)
    addToggle(visualSec,"ESP",false,function(val) print("ESP:",val) end)
    addSlider(mainSec,"Speed",1,100,1,16,function(val) print("Speed",val) end)
    addDropdown(mainSec,"Mode",{"Legit","Rage","Custom"},1,function(val,idx) print("Modo",val,idx) end)

    -- Funzione per renderizzare tutto
    local function render()
        renderSections()
    end

    -- Loop di aggiornamento
    local runService = game:GetService("RunService")
    runService.Heartbeat:Connect(function()
        -- Qui puoi aggiungere logica se vuoi aggiornamenti continui
    end)

    -- Mostra il menu
    function _G.ShowMenu()
        root.Visible=true
        applyHighlight()
    end

    function _G.HideMenu()
        root.Visible=false
    end

    -- Alternativa: toggle
    function _G.ToggleMenu()
        root.Visible=not root.Visible
        if root.Visible then applyHighlight() end
    end

    -- Per cambiare keybind
    function _G.SetKey(key)
        -- Non implementato in questa versione
    end

    -- Inizia subito
    _G.ShowMenu()

end

createMenu()

end

createMenu()
